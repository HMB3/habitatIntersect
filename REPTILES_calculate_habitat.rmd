---
title: "nenswniche : a package for rapidly estimating multiple species ranges and habitat suitability"
authors: "Hugh Burley, Shawn Laffan, Will Cornwell, Adrian Fisher"
date: "March 2021"
output:
  github_document:
  toc: true   
toc_depth: 4            
toc_float: true
number_sections: false  
vignette: >
%\VignetteIndexEntry{README}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  keep_md: true
  theme: united     
highlight: tango        
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
chunk_output_type: console
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---

\

Aim :: The Code below takes the species distribution models (SDMs) for each REPTILEebrate taxa, and the SDMs for their host plant 
taxa, and intersects the SDMs with a Vegetation layer (), then intersects the combined habitat layer with a fire severity layer.

\

To install, run :

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Set environments 
## java memory limit and temporary raster dir
rm(list = ls())
options(java.parameters = "-Xmx64000m")
Sys.setenv(JAVA_HOME='C:\\Program Files\\Java\\jre1.8.0_321')


## Function to load or install packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos="https://cran.csiro.au/")
  sapply(pkg, require,      character.only = TRUE)
}


## Load packages 
library(nenswniche)
data('sdmgen_packages')
ipak(sdmgen_packages)

## Set temporary raster dir for the terra package
rasterOptions(tmpdir = 'E:/Bush_fire_analysis/nenswniche/TEMP')
terraOptions(memfrac = 0.5, 
             tempdir = 'E:/Bush_fire_analysis/nenswniche/TEMP')

```


\


# 1). Read in Vegetation and Fire Rasters to combine with ivertebrate occurrence data

\

First, get all the rasters to compare with SDM modelling :

- SDM output     (Binary habitat suitability, 0-1, 100m) (Source)
- NSW Vegetation (Veg maps, categorical, 100m)           (Source)
- Fire layers    (FESM, 0-5, 100m)                       (https://datasets.seed.nsw.gov.au/dataset/fire-extent-and-severity-mapping-fesm)

\


```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}


## To Do :
## 1). Check the output with Shawn
## 2). Check all the rasters align in QGIS
## 2). Get examples working for the 18 bugs with host species
results_dir   <- './output/reptile_maxent/results/'
habitat_dir   <- './output/reptile_maxent/Habitat_suitability/'
threshold_dir <- './output/reptile_maxent/Habitat_suitability/SDM_thresholds/'
intersect_dir <- './output/reptile_maxent/Habitat_suitability/FESM_SDM_intersect/'


## SDM output, re-sampled to 100m
study_sdm_binary <- stack(
  list.files(threshold_dir,
             'current_suit_not_novel_above', full.names = TRUE))


## Get the names of all the layers
sdm_threshold_features <- list.files(path       = threshold_dir,
                                     pattern    = '_current_suit_not_novel_above_', 
                                     recursive  = FALSE,
                                     full.names = FALSE) %>% 
  
  .[grep(".tif", .)] %>% gsub('.tif', '', .)

sdm_threshold_list        <- sdm_threshold_features %>% as.list() 
names(sdm_threshold_list) <- sdm_threshold_features


## FESM   : https://datasets.seed.nsw.gov.au/dataset/fire-extent-and-severity-mapping-fesm
## VALUES : 1-4, burn intensity from 2019-2020 fires, originally @ 10m resolution, re-sampled to 100m
FESM_NSW_10m  <- raster('./data/Remote_sensing/FESM/fesm_20200319_albers.tif')
FESM_AUS_20m  <- raster('./data/Remote_sensing/FESM/NBR_Burn_severity_classed_ALB.tif')


## Read in feature layers for fire that have been repaired in ArcMap
FESM_east_20m <- st_read('./data/Remote_sensing/FESM/Fire_perimeters_for_forests_and_woodlands.shp') %>% 
  st_transform(., st_crs(3577)) %>% filter(!st_is_empty(.)) %>% as_Spatial() %>% repair_geometry() 


## NIAFED data is much coarser and has more empty geometries
Burnt_unburnt <- 
  
  st_read('./data/Remote_sensing/NIAFED/NIAFED_combo_east_Alb.shp') %>%
  st_transform(., st_crs(3577)) %>% 
  filter(!st_is_empty(.)) 


## Read in the SDM data, to intersect with the Veg layers
# SVTM_Veg_Class_GDA          = readRDS('./data/Remote_sensing/aligned_rasters/SVTM_Veg_Class_GDA.rds')
AUS_forest_RS_ras           = raster('./data/Remote_sensing/Veg_data/Forest_cover/alpsbk_aust_y2009_sf1a2_forest.tif')
AUS_forest_RS_feat          = st_read('./data/Remote_sensing/Veg_data/Forest_cover/Aus_forest_cover_east_coast_classes.shp') %>% 
  st_transform(., st_crs(3577))


## Read in the reptile points
SDM.SPAT.OCC.ALL.REPTILE.BG = readRDS('./output/reptile_maxent/results/SDM_SPAT_OCC_BG_ALL_REPTILE_TAXA_VARS.rds')


## Check projections and resolutions
projection(FESM_NSW_10m);projection(study_sdm_binary[[1]]);projection(SDM.SPAT.OCC.ALL.REPTILE.BG)
raster::xres(FESM_AUS_20m);raster::xres(study_sdm_binary[[1]])


``` 

\

# 2). Select pixels from the Vegetation Habitat Raster that intersect the records for each REPTILEebrate taxa, as habitat surrogates

\

Let's intersect the SDMs for each REPTILE taxa with the Vegetation Habitat Raster

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Create a table of maxent results
## This function aggregates the results for models that ran successfully
target_reptiles  <- c('Phyllurus platurus',  'Eulamprus tympanum',      'Hoplocephalus bungaroides', 'Drysdalia rhodogaster', 
                      'Amalosia lesuerii',   'Cryptophis nigrescens',   'Eulamprus heatwolei',       'Varanus varius',
                      'Morelia spilota',     'Pseudechis porphyriacus', 'Varanus rosenbergi')


REPTILES.MAXENT.RESULTS = compile_sdm_results(taxa_list    = target_reptiles,
                                              results_dir  = 'output/reptile_maxent/back_sel_models',
                                              data_path    = './output/reptile_maxent/Habitat_suitability/',
                                              sdm_path     = './output/reptile_maxent/back_sel_models/',
                                              save_data    = TRUE,
                                              save_run     = 'REPTILES_target_reptiles')


## Get map_taxa from the maxent results table above, change the species column,
## then create a list of logistic thresholds
reptiles_map_taxa <- REPTILES.MAXENT.RESULTS$searchTaxon %>% gsub(" ", "_", .,)
gc()

``` 

\


# 3). Calculate Estimated fire habitat after the 2019-2020 Fires


For each REPTILE species, calculate the % of suitable habitat that was burnt by the
2019-2020 fires. We can do this by combining pixels in the rasters like this: 

\

- [REPTILE_SDM ] * Fire_layer * Forested areas

\

This will give us the % of suitable habitat that was burnt, as well as % burnt in each Vegetation class.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Calculate Insect habitat - fails after this species?
## Code is stalling before or after :: Naranjakotta - it should be the taxa either side of that...
calculate_taxa_habitat_features(taxa_list          = sort(REPTILES.MAXENT.RESULTS$searchTaxon),
                                targ_maxent_table  = REPTILES.MAXENT.RESULTS,
                                target_path        = './output/reptile_maxent/back_sel_models/',
                                threshold_path     = paste0(threshold_dir, 'reptiles_sdm_thresholds_combo.gpkg')
                                intersect_path     = 'G:/North_east_NSW_fire_recovery/output/reptile_maxent/Habitat_suitability/SVTM_intersect',
                                layer_list         = sdm_threshold_list,
                                main_int_layer     = Burnt_unburnt,
                                second_int_layer   = AUS_forest_RS_feat,
                                output_path        = './output/reptile_maxent/Habitat_suitability/FESM_SDM_intersect/',
                                poly_path          = 'data/Spatial_data/Study_areas/AUS_2016_AUST.shp',
                                epsg               = 3577,
                                write_rasters      = TRUE)

``` 


\

For each taxa, we create a table of the area in square kilometers of suitable habitat that intersects with each burn 
intensity category from the FESM fire intensity layer. Let's combine all those tables together, to create a master 
table of estimated area.


```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Calculate Insect habitat
REPTILE.FESM.list <- list.files('./output/reptile_maxent/Habitat_suitability/FESM_SDM_intersect/', 
                                pattern     = '_intersect_Fire.csv', 
                                full.names  = TRUE, 
                                recursive   = TRUE) 


## Now combine the SUA tables for each species into one table 
REPTILE.FESM.TABLE <- REPTILE.FESM.list %>%
  
  ## pipe the list into lapply
  lapply(function(x) {
    
    ## create the character string
    f <- paste0(x)
    
    ## load each .RData file
    d <- read.csv(f)
    d
    
  }) %>%
  
  ## finally, bind all the rows together
  bind_rows


## Subset to just the analysis species - some species did not process properly?
REPTILE.FESM.TABLE <-  REPTILE.FESM.TABLE[REPTILE.FESM.TABLE$Habitat_taxa %in% sort(REPTILES.MAXENT.RESULTS$searchTaxon) , ] %>%  
  .[complete.cases(.), ]


## How many taxa have been processed?
length(unique(REPTILE.FESM.TABLE$Habitat_taxa))
View(REPTILE.FESM.TABLE)


## Save the FESM intersect results to file
write_csv(REPTILE.FESM.TABLE, 
          './output/reptile_maxent/Habitat_suitability/FESM_SDM_intersect/REPTILE_TAXA_SDM_VEG_intersect_Fire.csv')


``` 


\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_gain_loss_0.3799_2030.png?raw=true)

**Figure 1.** Example of a combined map of change in climatic suitability from current conditions to 2070. 
Species occurrence points are plotted in red on the left panel. The cells in the right and bottom panels 
are coded as either lost (orange cells - present now but not in 2070 according to 4 or more GCMs), 
gained (green cells - absent now, but present in 2070), stable (blue cells - present now and in 2070), 
or never suitable (white cells - never present).

\


