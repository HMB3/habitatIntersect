---
title: "nenswniche : a package for rapidly estimating multiple species ranges and habitat suitability"
authors: "Hugh Burley, Shawn Laffan, Will Cornwell, Adrian Fisher"
date: "March 2021"
output:
  github_document:
  toc: true   
toc_depth: 4            
toc_float: true
number_sections: false  
vignette: >
%\VignetteIndexEntry{README}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  keep_md: true
  theme: united     
highlight: tango        
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
chunk_output_type: console
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---

\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the 
environmental range of a species within Australia, from downloading occurrence records, through to 
creating maps of predicted climatic suitability across Australia at 1km*1km resolution. An example 
of this work is published in the journal Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 

\

To install, run :

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Set environments 
## java memory limit and temporary raster dir
rm(list = ls())
options(java.parameters = "-Xmx64000m")


## Function to load or install packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos="https://cran.csiro.au/")
  sapply(pkg, require,      character.only = TRUE)
}


## Load packages 
library(nenswniche)
data('sdmgen_packages')
ipak(sdmgen_packages)

## Set temporary raster dir for the terra package
terraOptions(memfrac = 0.5, 
             tempdir = 'G:/North_east_NSW_fire_recovery/TEMP')

```


\


# Read Raster data

\

For each Invertebrate species, let's calculate the % of suitable habitat that was burnt by the
2019-2020 fires. We can do this using raster multiplication...


Create a function that loops through all species, and multiplies the thresholded SDM rasters by
the fire severity layers (i.e. the FESM layers). 


First, re-sample all the layers to 100m


\

First, get all the rasters to compare with SDM modelling :

- Fire layers    (FESM, 0-4, 100m)
- NSW Vegetation (Veg maps, categorical, 100m) 
- SDM output     (Binary habitat suitability, 0-1, 100m)

\


```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## FESM   : https://datasets.seed.nsw.gov.au/dataset/fire-extent-and-severity-mapping-fesm
## VALUES : 1-4, burn intensity from 2019-2020 fires, originally @ 10m resolution, re-sampled to 100m
FESM_1000m_GDA_study <- terra::rast('./output/veg_climate_topo_maxent/Habitat_suitability/aligned_rasters/FESM_500m_meanx_100m.tif')
xres(FESM_1000m_GDA_study)
yres(FESM_1000m_GDA_study)


## SVTM Rasters : https://www.environment.nsw.gov.au/vegetation/state-vegetation-type-map.htm
## The State Vegetation Type Map (SVTM)  of Plant Community Types across NSW, originally @ 5m resolution, re-sampled to 100m
## Values categorical :
SVTM           <- terra::rast('./output/veg_climate_topo_maxent/Habitat_suitability/aligned_rasters/SVTM_100m.tif')
SVTM_ras       <- raster('./output/veg_climate_topo_maxent/Habitat_suitability/aligned_rasters/SVTM_100m.tif')
GBAM           <- terra::rast('./output/veg_climate_topo_maxent/Habitat_suitability/aligned_rasters/GBAM_100m.tif')
SVTM_GDA_study <- terra::rast('./data/Remote_sensing/Veg_data/NSW_vegetation_types/SVTM_PCTID_study.tif')


## SDM output, re-sampled to 100m
study_sdm_binary <- stack(
  list.files('./output/veg_climate_topo_maxent/Habitat_suitability/SDM_thresholds',
             'current_suit_not_novel_above', full.names = TRUE))


## All in GDA Albers
projection(FESM_1000m_GDA_study);projection(SVTM_GDA_study);projection(study_sdm_binary[[1]])
xres(FESM_1000m_GDA_study);xres(SVTM);xres(study_sdm_binary[[1]])


## Read in the SDM data, to intersect with the Veg layers
SDM.SPAT.OCC.BG.GDA       = readRDS('./output/results/SDM_SPAT_OCC_BG_GDA_ALL_TARGET_INVERT_TAXA.rds')
SDM.PLANT.SPAT.OCC.BG.GDA = readRDS('./output/results/SDM_SPAT_OCC_BG_TARGET_HOST_PLANTS.rds')


``` 


\

# Create Look up tables of Veg classes - use this to assign Insects to Veg types

\


```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}


## Align the
SVTM_LUT <- read_csv('./output/veg_climate_topo_maxent/Habitat_suitability/SVTM_attribute_table.csv') %>% 
  select(PCTID, Count, PCTname, vegClass, vegForm,  temp)


## Create a LUT of the Veg class
NSW_RS_Veg_Class <- SVTM_LUT %>%
  
  ## Group by Veg class and calculate % of each class
  group_by(vegClass) %>% 
  summarise(Pixel_Count = sum(Count)) %>%
  mutate(Proportion     = Pixel_Count/sum(Pixel_Count),
         Proportion     = round(Proportion, 5),
         Proportion     = formattable::percent(Proportion))

## Veg class
vegClass_levels <- SVTM_LUT %>% select(., vegClass) %>% distinct()
vegForm_levels  <- SVTM_LUT %>% select(., vegForm)  %>% distinct()


## Create a LUT of the Veg Form
NSW_RS_Veg_Form <- SVTM_LUT %>%
  
  ## Group by Veg Form and calculate % of each form
  group_by(vegForm) %>% 
  summarise(Pixel_Count = sum(Count)) %>%
  mutate(Proportion     = Pixel_Count/sum(Pixel_Count),
         Proportion     = round(Proportion, 5),
         Proportion     = formattable::percent(Proportion))


## Save the output, and use in the LUT of all taxa
# write_csv(NSW_RS_Veg_Class, './output/veg_climate_topo_maxent/Habitat_suitability/NSW_RS_Veg_Class_LUT.csv')
# write_csv(NSW_RS_Veg_Form,  './output/veg_climate_topo_maxent/Habitat_suitability/NSW_RS_Veg_Form_LUT.csv')



## Now set the attributes for the SVTM data.
## Use the 'VegClass' - 97 categories, rather than 'form, 20 categories
levels(SVTM) <- SVTM_LUT$vegClass


``` 

\

# Re-sample the Fire and Veg rasters to the same grid as the SDMs

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Align the
SVTM_align <- align_rasters(unaligned     = SVTM,
                            reference     = study_sdm_binary[[1]],
                            # dstfile       = './output/veg_climate_topo_maxent/Habitat_suitability/aligned_rasters/SVTM_NENSW.tif',
                            output_Raster = FALSE,
                            nThreads      = 5,
                            projres_only  = FALSE,
                            verbose       = FALSE)

``` 

\

# 1). Select pixels from the Veg Raster by intersection 

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Threshold the Plant SDM models to be either 0 or 1
taxa_records_habitat_intersect(taxa_df        = SDM.SPAT.OCC.BG.GDA,
                               taxa_list      = analysis_taxa,
                               taxa_level     = 'species',
                               habitat_raster = SVTM,
                               output_path    = './output/veg_climate_topo_maxent/Habitat_suitability/SVTM_selection/',
                               country_shp    = 'AUS',
                               country_prj    = CRS("+init=EPSG:3577"),
                               write_rasters  = TRUE)

``` 

\

# 2). Select pixels from the Veg Raster by expert opinion   

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Threshold the Plant SDM models to be either 0 or 1
taxa_records_habitat_intersect(taxa_df       = SDM.SPAT.OCC.BG.GDA,
                               taxa_list     = analysis_taxa,
                               maxent_table  = MAXENT.RESULTS,
                               output_path   = './output/veg_climate_topo_maxent/Habitat_suitability/SVTM_selection/',
                               country_shp   = 'AUS',
                               country_prj   = CRS("+init=EPSG:3577"),
                               write_rasters = TRUE)

``` 

\

# Compare SDM models with the Fire and Veg layers

- Fire layers    (FESM)
- NSW Vegetation (Veg maps)


We can use the “combine” tool to run queries on the raster.


For example, we can combine the Keith Class from the SVTM map, with the expected range of each species (a and b). 
You will be able to search the geotiff attribute table using Keith Class = x,d,f etc. where species range = b. 
We can then extract by attributes to create a new raster with the Keith Class you want, only inside the species range.


\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Combine GCM predictions and calculate gain and loss for 2030 
## Then loop over the species folders and climate scenarios


``` 


\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_gain_loss_0.3799_2030.png?raw=true)

**Figure 3.** Example of a combined map of change in climatic suitability from current conditions to 2070. 
Species occurrence points are plotted in red on the left panel. The cells in the right and bottom panels 
are coded as either lost (orange cells - present now but not in 2070 according to 4 or more GCMs), 
gained (green cells - absent now, but present in 2070), stable (blue cells - present now and in 2070), 
or never suitable (white cells - never present).

\

