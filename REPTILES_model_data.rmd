---
title: "nenswniche : a package for rapidly estimating multiple species ranges and habitat suitability"
authors: "Hugh Burley, Shawn Laffan, Will Cornwell, Adrian Fisher"
date: "March 2021"
output:
  github_document:
  toc: true   
toc_depth: 4            
toc_float: true
number_sections: false  
vignette: >
%\VignetteIndexEntry{README}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  keep_md: true
  theme: united     
highlight: tango        
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
chunk_output_type: console
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---

\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the environmental range of a taxon within Australia, from downloading occurrence records, through to creating maps of predicted climatic suitability across Australia at 1km*1km resolution. An example of this work is published in the journal Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 

\

To install, run :

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Set env
rm(list = ls())
#if (!Sys.getenv("JAVA_TOOL_OPTIONS")) {
if (all(Sys.getenv("JAVA_HOME")=="")) {
  Sys.setenv(JAVA_HOME='C:\\Program Files\\Java\\jre1.8.0_331')
}
if (all(Sys.getenv("JAVA_TOOL_OPTIONS")=="")) {
  options(java.parameters = "-Xmx64G")
}

options(warn=0)

## Function to load or install packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos = "https://cran.csiro.au/")
  sapply(pkg, require, character.only = TRUE)
}


## Load packages
#devtools::install_github("HMB3/nenswniche")
library(nenswniche)
data('sdmgen_packages')
ipak(sdmgen_packages)


## The functions expect these folders,
main_dir             <- paste0(getwd(), "/")
tempdir              <- './TEMP/'
ALA_dir              <- './data/ALA/'
out_dir              <- './output/'

reptile_rs_dir         <- './output/reptile_maxent/'
reptile_back_dir       <- './output/reptile_maxent/back_sel_models/'
reptile_full_dir       <- './output/reptile_maxent/full_models/'
reptile_results_dir    <- './output/reptile_maxent/results/'

reptile_habitat_dir    <- './output/reptile_maxent/Habitat_suitability/'
reptile_inters_dir     <- './output/reptile_maxent/Habitat_suitability/Veg_intersect/'
reptile_thresh_dir     <- './output/reptile_maxent/Habitat_suitability/SDM_thresholds/'
reptile_fire_dir       <- './output/reptile_maxent/Habitat_suitability/FESM_SDM_intersect/'


## Try and set the raster temp directory to a location not on the partition, to save space
rasterOptions(tmpdir = tempdir)
terraOptions(memfrac = 0.5, 
             tempdir = tempdir) 

```

\
\
\

# Background

This code is being developed at UNSW, to help investigate
the impacts of the 2019/2020 bush fires on Insects in the North East Forests 
of New South Wales. The aim is to create a pipeline that rapidly assesses 
the habitat suitability of the threatened insect species under current 
environmental conditions. There are three ways to estimate habitat suitability :

- Habitat Suitability Models using geographic records for each REPTILESebrate taxon
- Habitat Suitability Models using geographic records of host plants for each REPTILESebrate taxon
- Intersecting geographic records of each REPTILESebrate taxon with vegetation maps (e.g. remote sensed vegetation layers) 

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=TRUE}


## Original taxa
target_reptiles <- c('Phyllurus platurus',  'Eulamprus tympanum',      'Hoplocephalus bungaroides', 'Drysdalia rhodogaster', 
                     'Amalosia lesuerii',   'Cryptophis nigrescens',   'Eulamprus heatwolei',       'Varanus varius',
                     'Morelia spilota',     'Pseudechis porphyriacus', 'Varanus rosenbergi')

## Threatened taxa
threat_reptiles <- read_excel(paste0(ALA_dir, 'REPTILES/endangered_and_priority_reptiles.xlsx'),
                              sheet = 'NSW_threat_reptiles')

priority_reptiles <- threat_reptiles %>% 
  dplyr::select(Wildlife_recovery_priority_tranche_2) %>% 
  na.omit() %>% 
  .$Wildlife_recovery_priority_tranche_2


nsw_reptiles <- threat_reptiles %>% 
  dplyr::select(ScientificName) %>% 
  .$ScientificName %>% c(., target_reptiles, priority_reptiles) %>% 
  unique() %>% sort()


setdiff(priority_reptiles, nsw_reptiles)


```




# 250m Climate, Soil and terrain variables

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

aus.climate.veg.grids.250m <- raster::stack(
  list.files('./data/CSIRO_layers/250m/AUS/',      pattern =".tif", full.names = TRUE))

east.climate.veg.grids.250m  <- raster::stack(
  list.files('./data/CSIRO_layers/250m/FESM_EXT/', pattern =".tif", full.names = TRUE))


names(aus.climate.veg.grids.250m)[1:11] <- 
  names(east.climate.veg.grids.250m)[1:11] <- 
  c("Tree_canopy_peak_foliage_total",
    "Plant_cover_fraction_0_5m", 
    "Plant_cover_fraction_5_10m",  
    "Plant_cover_fraction_10_30m",      
    "Plant_cover_fraction_30m",
    "Total_Plant_cover_fraction",  
    "Tree_canopy_height_25th", 
    "Tree_canopy_height_50th", 
    "Tree_canopy_height_75th",   
    "Tree_canopy_height_95th",   
    "Tree_canopy_peak_foliage")

identical(names(east.climate.veg.grids.250m),
          names(aus.climate.veg.grids.250m))

## Now remove the individual rasters
rm(list = ls(pattern = 'aus_'))
rm(list = ls(pattern = 'east_'))

aus_annual_precip       <- raster('./data/CSIRO_layers/250m/AUS/Extra/Annual_precip_WGS84.tif')
aus_annual_precip_alb   <- raster('./data/CSIRO_layers/250m/AUS/Extra/Annual_precip_GDA_ALB.tif')


## Should be 1km*1km, It should havle a value of 1 for land, and NA for the ocean
aus_annual_precip_alb[aus_annual_precip_alb > 0] <- 1
template_raster_250m <- aus_annual_precip_alb
gc()

``` 

\



# Run SDMs 

\

Once the geographic data for all taxa has been processed and cleaned, we can run species distribution models.
The sdm function runs two maxent models: a full model using all variables, and backwards selection. 
Given a candidate set of predictor variables, the backwards selection function identifies a subset 
of variables that meets specified multi-collinearity criteria. Subsequently, backward step-wise variable 
selection is used to iteratively drop the variable that contributes least to the model, 
until the contribution of each variable meets a specified minimum, or until a predetermined 
minimum number of predictors remains.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Read in the reptile taxa
SDM.SPAT.OCC.ALL.REPTILE.BG <- readRDS(paste0(reptile_results_dir, 'SDM_SPAT_OCC_BG_ALL_REPTILE_TAXA_VARS.rds'))


## Are the control taxa present? And the extra records?
'Pseudechis porphyriacus'        %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon
'Hoplocephalus bungaroides'      %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon
'Drysdalia rhodogaster'          %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon
'Ctenotus pantherinus ocellifer'    %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon
'Cyclodomorphus melanops elongatus' %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon
'Egernia roomi'                     %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon

nsw_reptiles %in% SDM.SPAT.OCC.ALL.REPTILE.BG$searchTaxon

## To Do :
## 1). Ryan has checked the taxonomy
## 2). Check the errors that Finlay may have found
bionet_sdm <- SDM.SPAT.OCC.ALL.REPTILE.BG %>% .[.$searchTaxon %in% 'Hoplocephalus bungaroides', ]
table(bionet_sdm$SOURCE)
plot(bionet_sdm)


## Run species-level models for all reptiles
run_sdm_analysis_no_crop(taxa_list               = nsw_reptiles[-35],
                         taxa_level              = 'species',
                         maxent_dir              = reptile_back_dir,     
                         bs_dir                  = reptile_back_dir,
                         sdm_df                  = SDM.SPAT.OCC.ALL.REPTILE.BG,
                         sdm_predictors          = names(aus.climate.veg.grids.250m),
                         
                         backwards_sel           = TRUE,      
                         template_raster         = template_raster_250m,
                         cor_thr                 = 0.8,  
                         pct_thr                 = 5, 
                         k_thr                   = 4, 
                         min_n                   = 10,  
                         max_bg_size             = 100000,
                         background_buffer_width = 100000,
                         shapefiles              = TRUE,
                         features                = 'lpq',
                         replicates              = 5,
                         responsecurves          = TRUE,
                         poly_path               = 'data/Feature_layers/Boundaries/AUS_2016_AUST.shp',
                         epsg                    = 3577)

gc()


## Run species-level models for all Hoplocephalus bungaroides
run_sdm_analysis_no_crop(taxa_list               = nsw_reptiles[35],
                         taxa_level              = 'species',
                         maxent_dir              = 'output/reptile_maxent_raster_update/full_models',     
                         bs_dir                  = 'output/reptile_maxent_raster_update/back_sel_models',
                         sdm_df                  = SDM.SPAT.OCC.ALL.REPTILE.BG,
                         sdm_predictors          = names(aus.climate.veg.grids.250m)[12:43],
                         
                         backwards_sel           = TRUE,      
                         template_raster         = template_raster_250m,
                         cor_thr                 = 0.8,  
                         pct_thr                 = 5, 
                         k_thr                   = 4, 
                         min_n                   = 10,  
                         max_bg_size             = 100000,
                         background_buffer_width = 100000,
                         shapefiles              = TRUE,
                         features                = 'lpq',
                         replicates              = 5,
                         responsecurves          = TRUE,
                         poly_path               = 'data/Feature_layers/Boundaries/AUS_2016_AUST.shp',
                         epsg                    = 3577)


gc()

``` 

\

# Project Species Distribution Models across Australia

\

The next stage of the process is to project the SDM predictions across geographic space.
First, we need to extract the SDM results from the models. Each model generates a 'threshold' 
of probability of occurrence (see ref), which we use to create map of habitat suitability 
across Australia (). 

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Create a table of maxent results
## This function aggregates the results for models that ran successfully
REPTILES.MAXENT.RESULTS <- compile_sdm_results(taxa_list    = nsw_reptiles,
                                               results_dir  = reptile_back_dir,
                                               data_path    = reptile_habitat_dir,
                                               sdm_path     = reptile_back_dir,
                                               save_data    = TRUE,
                                               save_run     = "REPTILES_target_reptiles")


## Get map_taxa from the maxent results table above, change the species column,
## then create a list of logistic thresholds
reptiles_map_taxa <- REPTILES.MAXENT.RESULTS$searchTaxon %>% gsub(" ", "_", .,)
gc()

``` 

\

The projection function takes the maxent models created by the 'fit_maxent_targ_bg_back_sel' function, 
and projects the models across geographic space - currently just for Australia. It uses the rmaxent 
package https://github.com/johnbaums/rmaxent. It assumes that the maxent models were generated by the 
'fit_maxent_targ_bg_back_sel' function. Note that this step is quite memory heavy, best run with > 64GB of RAM.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Project SDMs across the Study area for the REPTILES taxa
tryCatch(
  
  project_maxent_current_grids_mess(taxa_list       = rev(reptiles_map_taxa),    
                                    maxent_path     = reptile_back_dir,
                                    current_grids   = east.climate.veg.grids.250m,         
                                    create_mess     = TRUE,
                                    save_novel_poly = TRUE,
                                    output_path     = paste0(reptile_thresh_dir, 'reptiles_sdm_novel_combo.gpkg'),
                                    poly_path       = 'data/Feature_layers/Boundaries/AUS_2016_AUST.shp',
                                    epsg            = 3577),
  
  ## If the species fails, write a fail message to file.
  error = function(cond) {
    
    ## This will write the error message inside the text file, but it won't include the species
    file.create(file.path("output/reptile_maxent_raster_update/back_sel_models/mapping_failed_current.txt"))
    cat(cond$message, file = file.path("output/reptile_maxent_raster_update/back_sel_models/reptiles_mapping_failed_current.txt"))
    warning(cond$message)
    
  })

gc()


``` 

\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_mess_panel.png?raw=true)


**Figure 2.** Example of a continuous climatic suitability map for one plant species under 
current conditions. Species occurrence points are plotted in red on the left panel. The cells in the right 
panel are coded from 0 : no to low suitability, to 1 : highly suitable. The shaded areas on the right panel
indicate where the maxent model is extrapolating beyond the training data (i.e. the result of a MESS map).

\

To use the habitat suitability rasters in area calculations (e.g. comparing the area of suitable habitat
affected by fire), we need to convert the continuous suitability scores (ranging from 0-1) to binary values
(either 1, or 0). To do this, we need to pick a threshold of habitat suitability, below which the species 
is not considered present. Here we've chosen the 10th% Logistic threshold for each taxa (ref).

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Threshold the Reptile SDM models to be either 0 or 1
habitat_threshold(taxa_list     = sort(unique(REPTILES.MAXENT.RESULTS$searchTaxon)),
                  maxent_table  = REPTILES.MAXENT.RESULTS,
                  maxent_path   = './output/reptile_maxent_raster_update/back_sel_models/',
                  output_path   = paste0(threshold_folders, 'reptiles_sdm_thresholds_combo.gpkg'),
                  poly_path     = 'data/Feature_layers/Boundaries/AUS_2016_AUST.shp',
                  epsg          = 3577)

gc()


## Now copy the thresh-holded SDM rasters to stand alone folder (i.e. all taxa in one folder)
thresholded_sdms <- list.files(path    = './output/reptile_maxent_raster_update/back_sel_models/',
                               pattern = '_current_suit_not_novel_above_', 
                               recursive = TRUE,
                               full.names = TRUE) %>% 
  .[grep(".tif", .)] 


file.copy(from      = thresholded_sdms, 
          to        = 'output/reptile_maxent_raster_update/Habitat_suitability/SDM_thresholds/', 
          overwrite = TRUE, 
          recursive = TRUE, 
          copy.mode = TRUE)

``` 


\


