---
title: "nenswniche : a package for rapidly estimating multiple species ranges and habitat suitability"
authors: "Hugh Burley, Shawn Laffan, Adrian Fisher"
date: "March 2021"
output:
  github_document:
  toc: true   
toc_depth: 4            
toc_float: true
number_sections: false  
vignette: >
%\VignetteIndexEntry{README}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  keep_md: true
  theme: united     
highlight: tango        
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
chunk_output_type: console
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---

\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the environmental range of a species within Australia, from downloading occurrence records, through to creating maps of predicted climatic suitability across Australia at 1km*1km resolution. An example of this work is published in the journal Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 

\

To install, run :

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Function to load or install packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos="https://cran.csiro.au/")
  sapply(pkg, require, character.only = TRUE)
}

## These packages are not on cran, but are needed
# library(devtools)
# install_github('johnbaums/things')
# install_github('johnbaums/rmaxent')
# install_github('traitecoevo/taxonlookup')

## Main package 
# devtools::install_github("HMB3/nenswniche")

## Load packages 
library(nenswniche)
data('sdmgen_packages')
ipak(sdmgen_packages)

```

\
\
\

# Background

This code is being developed at UNSW, as part of a project investigating
the impacts of the 2019/2020 bush fires on Insects in the North East Forests 
of New South Wales. The aim is to create a pipeline that rapidly assesses 
the habitat suitability of the threatened insect species under current 
environmental conditions. 

\

# STEP  6 :: Run Global SDMs

\

Start the wiki from here, using the pre-prepared data

The next process is to run species distribution models using global records of each species.
The sdm function runs two maxent models: a full model using all variables, and backwards selection. 
Given a candidate set of predictor variables, the backwards selection function identifies a subset 
of variables that meets specified multi-collinearity criteria. Subsequently, backward step-wise variable 
selection is used to iteratively drop the variable that contributes least to the model, 
until the contribution of each variable meets a specified minimum, or until a predetermined 
minimum number of predictors remains.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## SDM.ALL.INS.SPP.BG   = readRDS('./output/results/SDM_SPAT_OCC_BG_ALL_INSECT_SPP.rds')
## SDM.TARG.INS.SPP.BG  = readRDS('./output/results/SDM_SPAT_OCC_BG_TARGET_INSECT_SPECIES.rds')
## SDM.ALL.PLANT.SPP.BG = readRDS('./output/results/SDM_SPAT_OCC_BG_ALL_PLANT_SPP.rds')


## SDM.ALL.INS.GEN.BG  = readRDS('./output/results/SDM_SPAT_OCC_BG_ALL_INSECT_GENERA.rds')
## SDM.TARG.INS.GEN.BG = readRDS('./output/results/SDM_SPAT_OCC_BG_TARGET_INSECT_GENERA.rds')

## SDM.ALL.INS.FAM.BG  = readRDS('./output/results/SDM_SPAT_OCC_BG_AUS_INSECT_FAMILIES.rds')
## SDM.TARG.INS.FAM.BG = readRDS('./output/results/SDM_SPAT_OCC_BG_TARGET_INSECT_FAMILIES.rds')



## To Do :
## 1). Search Errors - which ones are real?
## 3). Delete error folders
## 4). Re-Run
## 5). Get Gerry and Ryan to check the taxonomy


## Clean up the folders which have failed
run_sdm_analysis(species_list            = analysis_taxa,
                 maxent_dir              = 'output/veg_maxent/full_models',     
                 bs_dir                  = 'output/veg_maxent/back_sel_models',
                 sdm_df                  = SDM.ALL.INS.GEN.BG,
                 sdm_predictors          = names(aus.veg.grids),
                 
                 backwards_sel           = TRUE,      
                 template_raster         = template_raster_1km_mol,
                 cor_thr                 = 0.8,  
                 pct_thr                 = 5, 
                 k_thr                   = 4, 
                 min_n                   = 20,  
                 max_bg_size             = 70000,
                 background_buffer_width = 200000,
                 shapefiles              = TRUE,
                 features                = 'lpq',
                 replicates              = 5,
                 responsecurves          = TRUE,
                 country_shp             = AUS,
                 koppen_crop             = TRUE,
                 Koppen_zones            = Koppen_zones,
                 Koppen_raster           = Koppen_1975_1km)

``` 

\

# STEP 7 :: Project SDMs across Australia

\

The next stage of the process is to project the SDM predictions across geographic space.
First, we need to extract the SDM results from the models. Each model generates a 'threshold' 
of probability of occurrence (see ref), which we use to create map of habitat suitability 
across Australia (). 

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Create a table of maxent results
## This function aggregates the results for models that ran successfully
MAXENT.RESULTS = compile_sdm_results(species_list = analysis_taxa,
                                     results_dir  = 'output/full_maxent/back_sel_models',
                                     save_data    = FALSE,
                                     data_path    = "./output/full_maxent/summary_results/",
                                     sdm_path     = "./output/full_maxent/back_sel_models/",
                                     save_run     = "TARGET_INSECTS")

## Get map_taxa from the maxent results table above, change the species column,
## then create a list of logistic thresholds
map_taxa        <- MAXENT.RESULTS$searchTaxon %>% gsub(" ", "_", .,)
percent.10.log  <- MAXENT.RESULTS$Logistic_threshold
sdm.results.dir <- MAXENT.RESULTS$results_dir

``` 

\

The projection function takes the maxent models created by the 'fit_maxent_targ_bg_back_sel' function, 
and projects the models across geographic space - currently just for Australia. It uses the rmaxent package https://github.com/johnbaums/rmaxent. It assumes that the maxent models were generated by the 
'fit_maxent_targ_bg_back_sel' function. Note that this step is quite memory heavy, best run with > 32GB of RAM.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Create a local projection for mapping : Australian Albers
aus_albers <- CRS('+proj=aea +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=132 +x_0=0 +y_0=0 
                   +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs')

## Try and set the raster temp directory to a location not on the partition, to save space
rasterOptions(tmpdir = 'G:/Raster_temp/')

## Create current sdm map projections
tryCatch(
  project_maxent_current_grids_mess(country_shp     = AUS, 
                                    country_prj     = CRS("+init=EPSG:3577"),
                                    local_prj       = aus_albers,
                                    
                                    species_list    = rev(map_taxa),    
                                    maxent_path     = './output/veg_maxent/back_sel_models/',
            
                                    current_grids   = study.veg.current,         
                                    create_mess     = TRUE,
                                    save_novel_poly = FALSE),
  
  ## If the species fails, write a fail message to file
  error = function(cond) {
    
    ## This will write the error message inside the text file, but it won't include the species
    file.create(file.path("output/veg_maxent/back_sel_models/mapping_failed_current.txt"))
    cat(cond$message, file = file.path("output/veg_maxent/back_sel_models/mapping_failed_current.txt"))
    warning(cond$message)
    
  })

``` 

\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_mess_panel.png?raw=true)


**Figure 2.** Example of a continuous climatic suitability map for one plant species under 
current conditions. Species occurrence points are plotted in red on the left panel. The cells in the right 
panel are coded from 0 : no to low suitability, to 1 : highly suitable. The shaded areas on the right panel
indicate where the maxent model is extrapolating beyond the training data (i.e. the result of a MESS map).

\


# STEP 8 :: Aggregate SDM projections within Spatial units

\

Now that all the species models and projections have been run, we need to aggregate them 
across all six global circulation models. In order to aggregate the results, we need 
a shapefile to aggregate to. In this example, we'll use the Australian Significant Urban 
Areas, which were used in the Stoten article. A geo-tif of the Significant Areas is on 
Google drive:

\


```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Can't use the .rda, must use the file path
areal_unit_vec <- shapefile_vector_from_raster(shp_file = SUA,
                                               prj      = CRS("+init=EPSG:3577"),
                                               agg_var  = 'SUA_CODE16',
                                               temp_ras = aus.grids.current[[1]],
                                               targ_ras = './data/SUA_2016_AUST.tif')

## This is a vector of all the cells that either are or aren't in the rasterized shapefile
summary(areal_unit_vec)

``` 

\

This aggregation function uses the 10th% Logistic threshold for each species 
from the maxent models to threshold the rasters of habitat suitability (0-1) 
For each GCM. For each species, it sums the 6 GCMS to create a binary raster with 
cell values between 0-6. These cell values represent the number of GCMs where that 
cell had a suitability value above the threshold determined by maxent. We classify 
a cell has suitable if it met the threshold in > 4 GCMs, and use this combined 
raster to compare current and future suitability, measuring if the suitability 
of each cell is changing over time, remaining stable or was never suitable
It assumes that the maxent predictions were generated by the 'project_maxent_grids_mess'  
function. Note that this step is quite memory heavy, and is best run with 32GB of RAM.

\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Combine GCM predictions and calculate gain and loss for 2030 
## Then loop over the species folders and climate scenarios
tryCatch(mapply(sdm_area_cell_count,                      
                unit_shp      = './data/SUA_albers.rds',  ## This would have to change
                unit_vec      = areal_unit_vec, 
                sort_var      = "SUA_NAME16",
                agg_var       = "SUA_CODE16",
                world_shp     = './data/LAND_albers.rds', ## This would have to change
                country_shp   = './data/AUS_albers.rds',  ## This would have to change
                
                DIR_list      = sdm.results.dir,  
                species_list  = map_taxa,
                number_gcms   = 6,
                maxent_path   = 'output/maxent/back_sel_models/', 
                thresholds    = percent.10.log,
                time_slice    = 30,                     
                write_rasters = TRUE),
         
         ## If the species fails, write a fail message to file.
         error = function(cond) {
           
           ## This will write the error message inside the text file,
           file.create(file.path("output/maxent/back_sel_models/sua_count_failed_2030.txt"))
           cat(cond$message, 
               file=file.path("output/maxent/back_sel_models/sua_count_failed_2030.txt"))
           warning(cond$message)
           
         })

``` 


\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_gain_loss_0.3799_2030.png?raw=true)

**Figure 3.** Example of a combined map of change in climatic suitability from current conditions to 2070. 
Species occurrence points are plotted in red on the left panel. The cells in the right and bottom panels 
are coded as either lost (orange cells - present now but not in 2070 according to 4 or more GCMs), 
gained (green cells - absent now, but present in 2070), stable (blue cells - present now and in 2070), 
or never suitable (white cells - never present).

\

