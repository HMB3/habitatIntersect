---
title: "nenswniche : a package for rapidly estimating multiple species ranges and habitat suitability"
authors: "Hugh Burley, Shawn Laffan, Adrian Fisher"
date: "March 2021"
output:
  github_document:
  toc: true   
toc_depth: 4            
toc_float: true
number_sections: false  
vignette: >
%\VignetteIndexEntry{README}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  keep_md: true
  theme: united     
highlight: tango        
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
chunk_output_type: console
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---

\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the environmental range of a species within Australia, from downloading occurrence records, through to creating maps of predicted climatic suitability across Australia at 1km*1km resolution. An example of this work is published in the journal Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 

\

To install, run :

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Function to load or install packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, repos="https://cran.csiro.au/")
  sapply(pkg, require, character.only = TRUE)
}

## These packages are not on cran, but are needed
# library(devtools)
# install_github('johnbaums/things')
# install_github('johnbaums/rmaxent')
# install_github('traitecoevo/taxonlookup')

## Main package 
# devtools::install_github("HMB3/nenswniche")

## Load packages 
library(nenswniche)
data('sdmgen_packages')
ipak(sdmgen_packages)

```


\


# STEP 8 :: Aggregate results for each species and intersect with FESM

\

What do we want to do here? Create a stack of rasters using the FESM layers.
Then, for each species, intersect the current layers with the FESM layers.
This is not what Will was suggesting the other day...that's something more sophisticated.

But we can start with that. Make this function loop through all species, and intersect
The habitat layers with the FESM layers. How much from that can we keep? 


Consider the extent and resolution issues - FESM is 10m fire scars?
GEEBAM is the Keith Class veg units, but only for the areas that burnt...
How can we intersect the 1km rasters with the 10m layers? What do we want at the end,
a measure of % remaining/burnt for each species in each veg class?


\

```{r message=TRUE, echo=TRUE, warning=FALSE, eval=FALSE}

## Combine GCM predictions and calculate gain and loss for 2030 
## Then loop over the species folders and climate scenarios
tryCatch(mapply(sdm_area_cell_count,                      
                unit_shp      = './data/SUA_albers.rds',  ## This would have to change
                unit_vec      = areal_unit_vec, 
                sort_var      = "SUA_NAME16",
                agg_var       = "SUA_CODE16",
                world_shp     = './data/LAND_albers.rds', ## This would have to change
                country_shp   = './data/AUS_albers.rds',  ## This would have to change
                
                DIR_list      = sdm.results.dir,  
                species_list  = map_taxa,
                number_gcms   = 6,
                maxent_path   = 'output/maxent/back_sel_models/', 
                thresholds    = percent.10.log,
                time_slice    = 30,                     
                write_rasters = TRUE),
         
         ## If the species fails, write a fail message to file.
         error = function(cond) {
           
           ## This will write the error message inside the text file,
           file.create(file.path("output/maxent/back_sel_models/sua_count_failed_2030.txt"))
           cat(cond$message, 
               file=file.path("output/maxent/back_sel_models/sua_count_failed_2030.txt"))
           warning(cond$message)
           
         })

``` 


\

![fig1](https://github.com/HMB3/sdmgen/blob/master/output/Acacia_dealbata_gain_loss_0.3799_2030.png?raw=true)

**Figure 3.** Example of a combined map of change in climatic suitability from current conditions to 2070. 
Species occurrence points are plotted in red on the left panel. The cells in the right and bottom panels 
are coded as either lost (orange cells - present now but not in 2070 according to 4 or more GCMs), 
gained (green cells - absent now, but present in 2070), stable (blue cells - present now and in 2070), 
or never suitable (white cells - never present).

\

